{% extends 'Home/base.html' %}

{% block content %}
{% load static %}
<link href="{% static 'css/carpool.css' %}" rel="stylesheet" />

<div class="container-fluid" style="background-color: #00204a; padding: 20px;">
    <div class="text-center" style="background-color: #231a6f; border-radius: 40%;">
        
        <img src="{% static 'together.jpg' %}" alt="Carpool Image" class="img-fluid" style="max-width: 80%;border-radius: 40%;">
    </div>
</div>

    <div class="container mt-5">
        <h1 class="carpool-title">Carpool List</h1>


        <!-- Messages Section -->
        {% if messages %}
            <div class="alert alert-dismissible fade show" role="alert">
                {% for message in messages %}
                    <div>{{ message }}</div>
                {% endfor %}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        {% endif %}

        <div class="row">
            <div class="col-md-10">
                <div class="mb-4 text-right">
                    <a href="{% url 'carpool_add' %}" class="btn btn-custom">Add Carpool</a>
                    <a href="{% url 'reservation_invitations' %}" class="btn btn-custom">Reservation invitations</a>
                    <a href="{% url 'invitation_list' %}" class="btn btn-custom">Capool invitations</a>                   
                </div>
                
                <div class="row" id="carpool-cards">
                    {% for carpool in carpools %}
                        <div class="col-md-12 mb-3">
                            <div 
                                class="card p-3 d-flex flex-row align-items-center justify-content-between shadow-sm group-card" 
                                style="background-color: #f9f9f9; border-radius: 12px; cursor: pointer;"
                                onclick="window.location.href='{% url 'carpool_detail' carpool.id %}'"
                            >
                                <!-- Left Section: Carpool Icon -->
                                <div class="d-flex align-items-center">
                                    <div class="icon-wrapper rounded-circle d-flex justify-content-center align-items-center" style="background-color: #eef2f6; width: 60px; height: 60px; margin-right: 20px;">
                                        <span style="font-size: 24px; color: #555;">ðŸš—</span> <!-- Replace with an actual icon -->
                                    </div>
                                    <!-- Carpool Info -->
                                    <div>
                                        <h5 class="m-0 font-weight-bold">{{ carpool.name }}</h5>
                                        <p class="text-muted mb-1">
                                            <strong>Creator:</strong> 
                                            <a href="{% url 'user_detail' carpool.creator.id %}" style="text-decoration: none; color: #007bff;">
                                                {{ carpool.creator.email }}
                                            </a>
                                        </p>
                                    </div>
                                </div>
                                <!-- Hover Section: Buttons -->
                                {% if carpool.creator == user %}
                                    <div class="hover-buttons text-right d-none">
                                        <a href="{% url 'carpool_edit' carpool.id %}" class="btn btn-outline-warning btn-sm">Modify</a>
                                        <a href="{% url 'carpool_delete' carpool.id %}" 
                                        class="btn btn-outline-danger btn-sm" 
                                        onclick="event.stopPropagation(); return confirm('Are you sure you want to delete this carpool?');">
                                         Delete
                                     </a>                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% empty %}
                        <div class="col-12">
                            <p class="text-center">No carpools available.</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
            

            <!-- Right Column (Filter / Sort) -->
            <div class="col-md-2 mb-4 border-left">
                <!-- Dropdowns for Sorting -->
                <div class="mb-4">
                    <label for="sortSelect" class="form-label">Sort By</label>
                    <select class="form-control" id="sortSelect">
                        <option value="">Select Sort Option</option>
                        <option value="members_count">Sort by Members Count</option>
                        <option value="creation_date">Sort by Creation Date</option>
                    </select>
                </div>

                <form method="get" class="mb-4" id="filter-form">
                    <div class="input-group">
                        <div class="form-group">
                            <label for="filter_select">Filter by</label>
                            <select id="filter_select" name="filter_by" class="form-control">
                                <option value="">Select Filter</option>
                                <option value="name">Carpool Name</option>
                                <option value="creator_name">Creator Name</option>
                                <option value="member_name">Member Name</option>
                                <option value="members_count">Member Count</option>
                            </select>
                        </div>
                    </div>

                    <div id="filter_input_container">
                        <!-- This will be updated dynamically using JavaScript -->
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const filterSelect = document.getElementById("filter_select");
            const filterInputContainer = document.getElementById("filter_input_container");
            const carpoolCardsContainer = document.getElementById("carpool-cards");
            const sortSelect = document.getElementById("sortSelect");
    
            // Function to update the filter input fields
            function updateFilterInput() {
                const selectedFilter = filterSelect.value;
                filterInputContainer.innerHTML = ''; // Clear previous inputs
    
                if (selectedFilter === "name") {
                    filterInputContainer.innerHTML = `<input type="text" name="search" class="form-control" placeholder="Enter Carpool Name">`;
                } else if (selectedFilter === "creator_name") {
                    filterInputContainer.innerHTML = `<input type="text" name="search" class="form-control" placeholder="Enter Creator's Name">`;
                } else if (selectedFilter === "member_name") {
                    filterInputContainer.innerHTML = `<input type="text" name="search" class="form-control" placeholder="Enter Member's Name">`;
                } else if (selectedFilter === "members_count") {
                    filterInputContainer.innerHTML = `<input type="number" name="search" class="form-control" placeholder="Enter Minimum Members Count">`;
                }
            }
            function updateURL(params) {
                const url = new URL(window.location);
                Object.keys(params).forEach(key => url.searchParams.set(key, params[key]));
                window.history.pushState({}, '', url);
            }
            // Event listener for filter select change
            filterSelect.addEventListener('change', updateFilterInput);
            function fetchFilteredData(params) {
                const url = new URL(window.location.origin + window.location.pathname);
                Object.keys(params).forEach(key => url.searchParams.set(key, params[key]));
        
                fetch(url, {
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        carpoolCardsContainer.innerHTML = data.html;
                    })
                    .catch(error => console.error('Error fetching filtered data:', error));
            }
            // Function to apply filter dynamically (as you type)
            function applyFilter() {
                let filterBy = filterSelect.value;
                let searchQuery = filterInputContainer.querySelector('input') ? filterInputContainer.querySelector('input').value : '';
                
                const params = { filter_by: filterBy, search: searchQuery };
                updateURL(params);
                fetchFilteredData(params);
            }
    
            // Event listener for input field changes to dynamically filter
            filterInputContainer.addEventListener('input', applyFilter);
    
            // Function to apply sorting via dropdown selection
            function applySort() {
                let sortBy = sortSelect.value;
                let filterBy = filterSelect.value;
                let searchQuery = filterInputContainer.querySelector('input') ? filterInputContainer.querySelector('input').value : '';
    
                const params = { sort_by: sortBy, filter_by: filterBy, search: searchQuery };
                updateURL(params);
                fetchFilteredData(params);
            }
    
            // Event listener for sort dropdown change
            sortSelect.addEventListener('change', applySort);
        });
    </script>
    
    
    
    
{% endblock %}
