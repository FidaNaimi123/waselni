{% extends 'Home/base.html' %}

{% block content %}
{% load static %}
<link href="{% static 'css/carpool.css' %}" rel="stylesheet" />

<div class="container-fluid" style="background-color: #00204a; padding: 20px;">
    <div class="text-center" style="background-color: #231a6f; border-radius: 40%;">
        
        <img src="{% static 'together.jpg' %}" alt="Carpool Image" class="img-fluid" style="max-width: 80%;border-radius: 40%;">
    </div>
</div>

    <div class="container mt-5">
        <h1 class="carpool-title">Carpool List</h1>


        <!-- Messages Section -->
        {% if messages %}
            <div class="alert alert-dismissible fade show" role="alert">
                {% for message in messages %}
                    <div>{{ message }}</div>
                {% endfor %}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        {% endif %}

        <div class="row">
            <div class="col-md-10">
                <div class="mb-4 text-right">
                    <a href="{% url 'carpool_add' %}" class="btn btn-custom" id="add-carpool-btn" >Add Carpool</a>
                    <a href="{% url 'reservation_invitations' %}" class="btn btn-custom" id="reservation-invitations-btn">Reservation invitations</a>
                    <a href="{% url 'invitation_list' %}" class="btn btn-custom" id="capool-invitations-btn">Capool invitations</a>
                    <button id="voice-search-btn" class="btn btn-custom">Voice Search</button>             
                </div>
                
                <div class="row" id="carpool-cards">
                    {% for carpool in carpools %}
                        <div class="col-md-12 mb-3">
                            <div 
                                class="card p-3 d-flex flex-row align-items-center justify-content-between shadow-sm group-card" 
                                style="background-color: #f9f9f9; border-radius: 12px; cursor: pointer;"
                                onclick="window.location.href='{% url 'carpool_detail' carpool.id %}'"
                                id="carpool-{{ carpool.id }}"
                                data-carpool-id="{{ carpool.id }}"
                                data-carpool-creator="{{ carpool.creator.id }}"
                            >
                                <!-- Left Section: Carpool Icon -->
                                <div class="d-flex align-items-center">
                                    <div class="icon-wrapper rounded-circle d-flex justify-content-center align-items-center" style="background-color: #eef2f6; width: 60px; height: 60px; margin-right: 20px;">
                                        <span style="font-size: 24px; color: #555;">ðŸš—</span> <!-- Replace with an actual icon -->
                                    </div>
                                    <!-- Carpool Info -->
                                    <div>
                                        <h5 class="m-0 font-weight-bold">{{ carpool.name }}</h5>
                                        <p class="text-muted mb-1">
                                            <strong>Creator:</strong> 
                                            <a href="{% url 'user_detail' carpool.creator.id %}" style="text-decoration: none; color: #007bff;">
                                                {{ carpool.creator.email }}
                                            </a>
                                        </p>
                                    </div>
                                </div>
                                <!-- Hover Section: Buttons -->
                                {% if carpool.creator == user %}
                                    <div class="hover-buttons text-right d-none">
                                        <a href="{% url 'carpool_edit' carpool.id %}" class="btn btn-outline-warning btn-sm">Modify</a>
                                        <a href="{% url 'carpool_delete' carpool.id %}" 
                                        class="btn btn-outline-danger btn-sm" 
                                        onclick="event.stopPropagation(); return confirm('Are you sure you want to delete this carpool?');">
                                         Delete
                                     </a>                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% empty %}
                        <div class="col-12">
                            <p class="text-center">No carpools available.</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
            

            <!-- Right Column (Filter / Sort) -->
            <div class="col-md-2 mb-4 border-left">
                <!-- Dropdowns for Sorting -->
                <div class="mb-4">
                    <label for="sortSelect" class="form-label">Sort By</label>
                    <select class="form-control" id="sortSelect">
                        <option value="">Select Sort Option</option>
                        <option value="members_count">Sort by Members Count</option>
                        <option value="creation_date">Sort by Creation Date</option>
                    </select>
                </div>

                <form method="get" class="mb-4" id="filter-form">
                    <div class="input-group">
                        <div class="form-group">
                            <label for="filter_select">Filter by</label>
                            <select id="filter_select" name="filter_by" class="form-control">
                                <option value="">Select Filter</option>
                                <option value="name">Carpool Name</option>
                                <option value="creator_name">Creator Name</option>
                                <option value="member_name">Member Name</option>
                                <option value="members_count">Member Count</option>
                            </select>
                        </div>
                    </div>

                    <div id="filter_input_container">
                        <!-- This will be updated dynamically using JavaScript -->
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Initialize the SpeechRecognition object
            var recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US'; // You can change this language to match the language of your users
            recognition.continuous = true; // Keep the recognition on for continuous listening
            recognition.interimResults = true; // Allows for interim results (so it doesn't wait for you to finish speaking)
            const recognizedTextDisplay = document.createElement("div");
            recognizedTextDisplay.style.position = "fixed";
            recognizedTextDisplay.style.bottom = "20px";
            recognizedTextDisplay.style.left = "20px";
            recognizedTextDisplay.style.backgroundColor = "#f8f9fa";
            recognizedTextDisplay.style.padding = "10px";
            recognizedTextDisplay.style.border = "1px solid #ccc";
            recognizedTextDisplay.style.borderRadius = "5px";
            recognizedTextDisplay.style.boxShadow = "0 4px 6px rgba(0,0,0,0.1)";
            document.body.appendChild(recognizedTextDisplay);
    
            // Function to read carpool names aloud
            function readCarpoolNames() {
                const carpoolCardsContainer = document.getElementById("carpool-cards");
                
                // Get all carpool name elements (assuming each carpool name is in a .carpool-name element)
                const carpoolNames = carpoolCardsContainer.querySelectorAll('h5');
                
                // Create a speech synthesis utterance
                const utterance = new SpeechSynthesisUtterance();
                let carpoolText = '';
    
                // Concatenate all carpool names into a single string
                carpoolNames.forEach(function (card) {
                    const name = card.textContent.trim();
                    if (name) {
                        carpoolText += `${name}. `;
                    }
                });
    
                // Set the text to be read aloud
                utterance.text = carpoolText;
    
                // Set the language and other options (you can adjust as needed)
                utterance.lang = 'en-US';
                utterance.pitch = 1;
                utterance.rate = 1;
    
                // Speak the concatenated text
                window.speechSynthesis.speak(utterance);
            }
    
            // Read carpool names on page load
            readCarpoolNames();
    
            // Event handler for when speech is recognized
            recognition.onresult = function(event) {
                var transcript = event.results[event.results.length - 1][0].transcript.toLowerCase();
                console.log("Recognized speech: " + transcript);
                recognizedTextDisplay.textContent = "You said: " + transcript;
    
                // Check if the user said "view [carpool name]"
                var viewCommand = transcript.match(/view (.+)/);
                if (viewCommand) {
                    var carpoolName = viewCommand[1].toLowerCase();
                    var carpools = document.querySelectorAll('.group-card');
                    carpools.forEach(function(carpool) {
                        var carpoolNameText = carpool.querySelector('h5').textContent.toLowerCase();
                        if (carpoolNameText.includes(carpoolName)) {
                            carpool.click();
                        }
                    });
                }
    
                // Check if the user said "modify [carpool name]" or "delete [carpool name]"
                var modifyCommand = transcript.match(/modify (.+)/);
                var deleteCommand = transcript.match(/delete (.+)/);
                
                if (modifyCommand || deleteCommand) {
                    var carpoolName = (modifyCommand || deleteCommand)[1].toLowerCase();
                    var carpools = document.querySelectorAll('.group-card');
                    carpools.forEach(function(carpool) {
                        var carpoolNameText = carpool.querySelector('h5').textContent.toLowerCase();
                        if (carpoolNameText.includes(carpoolName)) {
                            // Check if the user is the group creator
                            var carpoolCreatorId = carpool.dataset.carpoolCreator;
                            var currentUserId = "{{ user.id }}"; // Get the current user ID dynamically
                            if (carpoolCreatorId == currentUserId) {
                                if (modifyCommand) {
                                    // Navigate to the modify page
                                    var carpoolId = carpool.dataset.carpoolId;
                                    window.location.href = window.location.href + carpoolId + "/edit/";  // Modify this URL to match your route
                                } else if (deleteCommand) {
                                    // Confirm deletion and trigger delete
                                    var carpoolId = carpool.dataset.carpoolId;
                                    if (confirm('Are you sure you want to delete this carpool?')) {
                                        window.location.href = window.location.href + carpoolId + "/delete/";  // Modify this URL to match your route
                                    }
                                }
                            } else {
                                alert("You are not the group creator.");
                            }
                        }
                    });
                }
    
                var addCarpoolCommand = transcript.match(/add carpool/);
                var reservationInvitationsCommand = transcript.match(/reservation invitations/);
                var carpoolInvitationsCommand = transcript.match(/carpool invitations/);
    
                if (addCarpoolCommand) {
                    // Trigger click for Add Carpool
                    document.getElementById("add-carpool-btn").click();
                } else if (reservationInvitationsCommand) {
                    // Trigger click for Reservation Invitations
                    document.getElementById("reservation-invitations-btn").click();
                } else if (carpoolInvitationsCommand) {
                    // Trigger click for Carpool Invitations
                    document.getElementById("capool-invitations-btn").click();
                }
    
                // Check if the user said "sort by [option]"
                var sortCommand = transcript.match(/sort by (.+)/);
                if (sortCommand) {
                    var sortOption = sortCommand[1].toLowerCase();
                    var sortSelect = document.getElementById("sortSelect");
    
                    // Match recognized command to the options in the dropdown
                    if (sortOption.includes("members count")) {
                        sortSelect.value = "members_count";
                    } else if (sortOption.includes("creation date")) {
                        sortSelect.value = "creation_date";
                    } else {
                        alert("Sort option not recognized.");
                        return;
                    }
    
                    // Trigger the sort function once a selection is made
                    applySort();
                }
            };
    
            // Start the recognition when the voice search button is clicked
            document.getElementById("voice-search-btn").onclick = function() {
                recognition.start();
            };
    
            // Optional: Handle errors (e.g., if speech recognition is not supported)
            recognition.onerror = function(event) {
                console.log('Speech recognition error: ' + event.error);
            };
        });
    </script>
        
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const filterSelect = document.getElementById("filter_select");
            const filterInputContainer = document.getElementById("filter_input_container");
            const carpoolCardsContainer = document.getElementById("carpool-cards");
            const sortSelect = document.getElementById("sortSelect");
    
            // Function to update the filter input fields
            function updateFilterInput() {
                const selectedFilter = filterSelect.value;
                filterInputContainer.innerHTML = ''; // Clear previous inputs
    
                if (selectedFilter === "name") {
                    filterInputContainer.innerHTML = `<input type="text" name="search" class="form-control" placeholder="Enter Carpool Name">`;
                } else if (selectedFilter === "creator_name") {
                    filterInputContainer.innerHTML = `<input type="text" name="search" class="form-control" placeholder="Enter Creator's Name">`;
                } else if (selectedFilter === "member_name") {
                    filterInputContainer.innerHTML = `<input type="text" name="search" class="form-control" placeholder="Enter Member's Name">`;
                } else if (selectedFilter === "members_count") {
                    filterInputContainer.innerHTML = `<input type="number" name="search" class="form-control" placeholder="Enter Minimum Members Count">`;
                }
            }
            function updateURL(params) {
                const url = new URL(window.location);
                Object.keys(params).forEach(key => url.searchParams.set(key, params[key]));
                window.history.pushState({}, '', url);
            }
            // Event listener for filter select change
            filterSelect.addEventListener('change', updateFilterInput);
            function fetchFilteredData(params) {
                const url = new URL(window.location.origin + window.location.pathname);
                Object.keys(params).forEach(key => url.searchParams.set(key, params[key]));
        
                fetch(url, {
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        carpoolCardsContainer.innerHTML = data.html;
                    })
                    .catch(error => console.error('Error fetching filtered data:', error));
            }
            // Function to apply filter dynamically (as you type)
            function applyFilter() {
                let filterBy = filterSelect.value;
                let searchQuery = filterInputContainer.querySelector('input') ? filterInputContainer.querySelector('input').value : '';
                
                const params = { filter_by: filterBy, search: searchQuery };
                updateURL(params);
                fetchFilteredData(params);
            }
    
            // Event listener for input field changes to dynamically filter
            filterInputContainer.addEventListener('input', applyFilter);
    
            // Function to apply sorting via dropdown selection
            function applySort() {
                let sortBy = sortSelect.value;
                let filterBy = filterSelect.value;
                let searchQuery = filterInputContainer.querySelector('input') ? filterInputContainer.querySelector('input').value : '';
    
                const params = { sort_by: sortBy, filter_by: filterBy, search: searchQuery };
                updateURL(params);
                fetchFilteredData(params);
            }
    
            // Event listener for sort dropdown change
            sortSelect.addEventListener('change', applySort);
        });
    </script>
    
    
    
    
{% endblock %}
