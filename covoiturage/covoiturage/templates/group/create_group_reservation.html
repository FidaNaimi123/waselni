{% extends 'Home/base.html' %}

{% block content %}
{% load static %}
<link href="{% static 'css/carpool.css' %}" rel="stylesheet" />

<div class="container mt-5">
    <h2 class="carpool-title mb-4">Create Group Reservation</h2>

    <form method="post" class="bg-light-grey p-5 rounded shadow-sm">
        {% csrf_token %}
        
        <!-- Carpool Selection -->
        <div class="form-group1 mb-4">
            <label for="selected_carpool" class="form-label">Select a Carpool:</label>
            <select name="selected_carpool" id="selected_carpool" class="form-control1" required>
                <option value="" selected disabled>Select a carpool</option>
                {% for carpool in carpools %}
                <option value="{{ carpool.id }}" 
                        data-members="{{ carpool.member_emails|join:',' }}" 
                        data-members-ids="{{ carpool.member_ids|join:',' }}"
                        data-creator="{{ carpool.creator.id }}"
                        data-creator-email="{{ carpool.creator.email }}">
                    {{ carpool.name }} (Creator: {{ carpool.creator.email }})
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Member Selection -->
        <div class="form-group1 mb-4">
            <label for="selected_members" class="form-label">Select Members:</label>
            <div id="member_checklist" class="form-check-list">
                <!-- Checkboxes will be dynamically populated based on the carpool selected -->
            </div>
        </div>

        <div class="text-center">
            <button type="submit" class="btn btn-custom">Reserve</button>
            <a href="{% url 'trajets_disponibles' %}" class="btn btn-custom">Trajets Disponibles</a>
        </div>
    </form>
    
</div>

<script>
    document.getElementById('selected_carpool').addEventListener('change', function () {
        var selectedCarpool = this.options[this.selectedIndex];
        
        // Get members' IDs and emails
        var memberIds = selectedCarpool.getAttribute('data-members-ids').split(",");
        var memberEmails = selectedCarpool.getAttribute('data-members').split(", ");
        var carpoolCreatorId = selectedCarpool.getAttribute('data-creator');
        var carpoolCreatorEmail = selectedCarpool.getAttribute('data-creator-email'); // Assuming creator's email is also passed
    
        // Get the member checklist element
        var memberChecklist = document.getElementById('member_checklist');
        
        // Clear current members
        memberChecklist.innerHTML = '';
    
        // Get the logged-in user's ID and email (pass these dynamically from the backend)
        var loggedInUserId = "{{ request.user.id }}";
        var loggedInUserEmail = "{{ request.user.email }}";
    
        // Add the creator to the list of members if the logged-in user is not the creator
        if (carpoolCreatorId !== loggedInUserId) {
            var checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = 'selected_members';
            checkbox.value = carpoolCreatorId; // Use creator ID as the value
            
            var label = document.createElement('label');
            label.textContent = carpoolCreatorEmail + ' (Creator)';
            label.className = 'form-check-label';
            
            var wrapper = document.createElement('div');
            wrapper.className = 'form-check';
            wrapper.appendChild(checkbox);
            wrapper.appendChild(label);
            memberChecklist.appendChild(wrapper);
        }
    
        // Loop through the members and add them to the checklist, excluding the logged-in user
        memberIds.forEach((id, index) => {
            if (id !== loggedInUserId) {
                var checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'selected_members';
                checkbox.value = id; // Use user ID as the value
                
                var label = document.createElement('label');
                label.textContent = memberEmails[index]; // Display email for readability
                label.className = 'form-check-label';
                
                var wrapper = document.createElement('div');
                wrapper.className = 'form-check';
                wrapper.appendChild(checkbox);
                wrapper.appendChild(label);
                memberChecklist.appendChild(wrapper);
            }
        });
    });
</script>
{% endblock %}
