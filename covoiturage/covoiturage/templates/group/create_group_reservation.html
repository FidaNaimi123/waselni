{% extends 'Home/base.html' %}

{% block content %}
{% load static %}
<link href="{% static 'css/carpool.css' %}" rel="stylesheet" />

    <div class="container mt-5">
        <h2 class="carpool-title mb-4">Create Group Reservation</h2>

        <form method="post" class="bg-light-grey p-5 rounded shadow-sm">
            {% csrf_token %}
            
            <!-- Carpool Selection -->
            <div class="form-group1 mb-4">
                <label for="selected_carpool" class="form-label">Select a Carpool:</label>
                <select name="selected_carpool" id="selected_carpool" class="form-control1" required>
                    <option value="" selected disabled>Select a carpool</option>
                    {% for carpool in carpools %}
                    <option value="{{ carpool.id }}" 
         data-members="{{ carpool.member_emails|join:',' }}" 
        data-members-ids="{{ carpool.member_ids|join:',' }}"
        data-creator="{{ carpool.creator.id }}"
        data-creator-email="{{ carpool.creator.email }}">
    {{ carpool.name }} (Creator: {{ carpool.creator.email }})
</option>

                    {% endfor %}
                </select>
            </div>

            <!-- Member Selection -->
            <div class="form-group1 mb-4">
                <label for="selected_members" class="form-label">Select Members:</label>
                <select name="selected_members" id="selected_members" class="form-control1" multiple required>
                    <!-- Members will be dynamically populated based on the carpool selected -->
                </select>
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-custom">Reserve</button>
                <a href="{% url 'trajets_disponibles' %}" class="btn btn-custom">Trajets Disponibles</a>

            </div>
        </form>
        
    </div>

    <script>
        document.getElementById('selected_carpool').addEventListener('change', function () {
            var selectedCarpool = this.options[this.selectedIndex];
            
            // Get members' IDs and emails
            var memberIds = selectedCarpool.getAttribute('data-members-ids').split(",");
            var memberEmails = selectedCarpool.getAttribute('data-members').split(", ");
            var carpoolCreatorId = selectedCarpool.getAttribute('data-creator');
            var carpoolCreatorEmail = selectedCarpool.getAttribute('data-creator-email'); // Assuming creator's email is also passed
        
            // Get the member select element
            var memberSelect = document.getElementById('selected_members');
            
            // Clear current members
            memberSelect.innerHTML = '';
        
            // Get the logged-in user's ID and email (pass these dynamically from the backend)
            var loggedInUserId = "{{ request.user.id }}";
            var loggedInUserEmail = "{{ request.user.email }}";
        
            // Add the creator to the list of members if the logged-in user is not the creator
            if (carpoolCreatorId !== loggedInUserId) {
                var option = document.createElement('option');
                option.value = carpoolCreatorId; // Use creator ID as the value
                option.textContent = carpoolCreatorEmail + ' (Creator)';
                memberSelect.appendChild(option);
            }
        
            // Loop through the members and add them to the select dropdown, excluding the logged-in user
            memberIds.forEach((id, index) => {
                if (id !== loggedInUserId) {
                    var option = document.createElement('option');
                    option.value = id; // Use user ID as the value
                    option.textContent = memberEmails[index]; // Display email for readability
                    memberSelect.appendChild(option);
                }
            });
        });
        
    </script>
{% endblock %}
